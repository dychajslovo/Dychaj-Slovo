<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zhrnutie objednávky – Dýchaj Slovo</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@600&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body{font-family:'Open Sans',sans-serif;margin:40px;background:#f4f4f4;color:#333}
        .c{max-width:800px;margin:auto;background:#fff;padding:30px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.1)}
        h1{font-family:'Fredoka',sans-serif;color:#2c495e;text-align:center;margin-bottom:20px}
        .info{margin:25px 0;padding:15px;background:#f8f8f8;border-radius:8px}
        .info strong{color:#2c495e}
        .price-line{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee}
        .total{font-size:1.3em;font-weight:600;color:#2c495e;margin-top:15px;padding-top:15px;border-top:3px double #ddd}
        .btn-container{display:flex;gap:15px;justify-content:center;margin-top:40px}
        .b{background:#2c495e;color:#fff;padding:14px 20px;border:none;border-radius:30px;cursor:pointer;font-weight:600;flex:1;max-width:200px;text-align:center;transition:all .3s}
        .b:hover{background:#3fcfd5}
        .back{background:#aaa}
        .back:hover{background:#999}
        .warning{margin:20px 0;padding:15px;background:#fff8e1;border-left:5px solid #ff9800;border-radius:4px}
        .status{display:none;margin-top:20px;padding:15px;border-radius:8px;text-align:center;font-weight:600}
        .success{background:#d4edda;color:#155724}
        .loading{background:#fff3cd;color:#856404}
        .error{background:#f8d7da;color:#721c24}
        @media(max-width:480px){.btn-container{flex-wrap:nowrap;overflow-x:auto;padding:0 10px}.b{min-width:140px}}
    </style>
</head>
<body>
<div class="c">
    <h1>Zhrnutie objednávky</h1>

    <div class="warning">
        Skontrolujte si objednávku a ak je správna, potvrďte tlačidlom „Objednať“.
    </div>

    <div class="info">
        <strong>Produkty v košíku:</strong><br>
        <div id="cartItems">Načítavam košík...</div>
    </div>

    <div class="info">
        <strong>Doprava:</strong><br>
        <span id="shippingMethod">-</span>
    </div>

    <div class="info">
        <strong>Fakturačné a doručovacie údaje:</strong><br>
        <div id="billingDetails">-</div>
    </div>

    <div style="margin-top:30px">
        <div class="price-line"><span>Cena produktov:</span> <strong id="subtotal">0,00 €</strong></div>
        <div class="price-line"><span>Doprava:</span> <strong id="shippingPrice">0,00 €</strong></div>
        <div class="price-line total"><span>Celkovo na úhradu:</span> <strong id="totalPrice">0,00 €</strong></div>
    </div>

    <div class="btn-container">
        <button class="b back" onclick="location.href='informacie.html'">Späť</button>
        <button class="b" onclick="sendOrder()">Objednať</button>
    </div>

    <div id="status" class="status"></div>
</div>

<script>
    const WEB3FORMS_KEY = 'efd76031-ddf0-442f-ba6f-552b04369b0e';

    // Načítanie dát
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const shippingRaw = localStorage.getItem('shipping') || '';
    const billingInfo = JSON.parse(localStorage.getItem('billingInfo') || '{}');

    // Spracovanie dopravy
    let shippingText = 'Nie je vybraná';
    let shippingPrice = 0;
    if (shippingRaw.includes('€3') || shippingRaw.includes('3,5')) {
        shippingText = 'Slovenská pošta – 3,50 €';
        shippingPrice = 3.5;
    } else if (shippingRaw.includes('PDF') || shippingRaw.includes('email')) {
        shippingText = 'PDF na e-mail – 0 €';
        shippingPrice = 0;
    }

    // Výpočet cien
    const subtotal = cart.reduce((sum, item) => sum + (parseFloat(String(item.price).replace(/[^0-9.,]/g, '').replace(',', '.')) || 0), 0);
    const total = subtotal + shippingPrice;

    // Zobrazenie
    document.getElementById('cartItems').innerHTML = cart.length === 0 
        ? '<em>Košík je prázdny</em>' 
        : cart.map(i => `• ${i.name || i.title || 'Produkt'} – ${i.price || '0 €'}`).join('<br>');

    document.getElementById('shippingMethod').textContent = shippingText;

    document.getElementById('subtotal').textContent = subtotal.toFixed(2).replace('.', ',') + ' €';
    document.getElementById('shippingPrice').textContent = shippingPrice.toFixed(2).replace('.', ',') + ' €';
    document.getElementById('totalPrice').textContent = total.toFixed(2).replace('.', ',') + ' €';

    const billingDiv = document.getElementById('billingDetails');
    billingDiv.innerHTML = billingInfo.name ? `
        ${billingInfo.name}<br>
        ${billingInfo.street || ''}<br>
        ${billingInfo.zip || ''} ${billingInfo.city || ''}<br>
        ${billingInfo.email || ''}
    ` : '<em>Nie sú vyplnené</em>';

    localStorage.setItem('finalTotal', total.toFixed(2));

    // === ODOSLANIE OBJEDNÁVKY ===
    async function sendOrder() {
        const status = document.getElementById('status');
        status.style.display = 'block';
        status.className = 'status loading';
        status.textContent = 'Odosielam objednávku...';

        // Číslo objednávky
        let counter = parseInt(localStorage.getItem('orderCounter') || '0') + 1;
        localStorage.setItem('orderCounter', counter);
        const orderId = `#${String(counter).padStart(3, '0')}`;

        const itemsText = cart.map(i => `${i.name || i.title || 'Produkt'} – ${i.price || '0 €'}`).join('\n');

        const formData = new FormData();
        formData.append('access_key', WEB3FORMS_KEY);
        formData.append('name', billingInfo.name || 'Neuvedené');
        formData.append('email', billingInfo.email || 'Neuvedený');
        formData.append('address', `${billingInfo.street || ''}, ${billingInfo.city || ''}, ${billingInfo.zip || ''}`.replace(/^,|,$/g, '').trim());
        formData.append('items', itemsText || 'Žiadne položky');
        formData.append('shipping', shippingText);
        formData.append('total', total.toFixed(2).replace('.', ',') + ' €');
        formData.append('order_id', orderId);

        try {
            const response = await fetch('https://api.web3forms.com/submit', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                // Uloženie do localStorage pre dashboard (ak chceš)
                const orderForDashboard = {
                    id: orderId,
                    date: new Date().toISOString(),
                    name: billingInfo.name || '',
                    email: billingInfo.email || '',
                    address: formData.get('address'),
                    items: itemsText,
                    shipping: shippingText,
                    total: total.toFixed(2).replace('.', ',') + ' €'
                };
                let orders = JSON.parse(localStorage.getItem('allOrders') || '[]');
                orders.unshift(orderForDashboard);
                localStorage.setItem('allOrders', JSON.stringify(orders));

                status.textContent = 'Objednávka bola úspešne odoslaná!';
                status.className = 'status success';

                localStorage.removeItem('cart');
                localStorage.removeItem('shipping');
                localStorage.removeItem('billingInfo');

                setTimeout(() => location.href = 'potvrdenie.html', 2000);
            } else {
                throw new Error('Web3Forms vrátilo chybu');
            }
        } catch (err) {
            console.error(err);
            status.textContent = 'Chyba odoslania. Skúste znova alebo kontaktujte nás.';
            status.className = 'status error';
        }
    }
</script>
</body>
</html>
